$(document).ready(function() {
    // Adding the clear Fix
    cols1 = $('#column-right, #column-left').length;

    if (cols1 == 2) {
        $('#content .product-layout:nth-child(2n+2)').after('<div class="clearfix visible-md visible-sm"></div>');
    } else if (cols1 == 1) {
        $('#content .product-layout:nth-child(3n+3)').after('<div class="clearfix hidden-xs"></div>');
    } else {
        $('#content .product-layout:nth-child(4n+5)').addClass('last');
    }

    // Highlight any found errors
    $('.text-danger').each(function() {
        var element = $(this).parent().parent();
        if (element.hasClass('form-group')) {
            element.addClass('has-error');
        }
    });

    // Currency
    $('#currency .currency-select').on('click', function(e) {
        e.preventDefault();
        $('#currency input[name=\'code\']').attr('value', $(this).attr('name'));
        $('#currency').submit();
    });

    // Language
    $('#language a').on('click', function(e) {
        e.preventDefault();
        $('#language input[name=\'code\']').attr('value', $(this).attr('href'));
        $('#language').submit();
    });

    /* Search */
    $('#search input[name=\'search\']').parent().find('button').on('click', function() {
        url = $('base').attr('href') + 'index.php?route=product/search';
        var value = $('header input[name=\'search\']').val();
        if (value) {
            url += '&search=' + encodeURIComponent(value);
        }
        location = url;
    });

    $('#search input[name=\'search\']').on('keydown', function(e) {
        if (e.keyCode == 13) {
            $('header input[name=\'search\']').parent().find('button').trigger('click');
        }
    });

    // Menu
    $('#menu .dropdown-menu').each(function() {
        var menu = $('#menu').offset();
        var dropdown = $(this).parent().offset();
        var i = (dropdown.left + $(this).outerWidth()) - (menu.left + $('#menu').outerWidth());
        if (i > 0) {
            $(this).css('margin-left', '-' + (i + 5) + 'px');
        }
    });

    // Product List
    $('#list-view').click(function() {
        $('#content .product-layout > .clearfix').remove();
        $(this).addClass('active');
        $('#grid-view').removeClass('active');
        $('#content .product-layout').attr('class', 'product-layout product-list col-xs-12');
        localStorage.setItem('display', 'list');
    });

    // Product Grid
    $('#grid-view').click(function() {
        $(this).addClass('active');
        $('#list-view').removeClass('active');
        $('#content .product-layout > .clearfix').remove();
        // What a shame bootstrap does not take into account dynamically loaded columns
        cols = $('#column-right, #column-left').length;

        if (cols == 2) {
            $('#content .product-layout').attr('class', 'product-layout product-grid col-lg-6 col-md-6 col-sm-12 col-xs-12');
        } else if (cols == 1) {
            $('#content .product-layout').attr('class', 'product-layout product-grid col-lg-4 col-md-4 col-sm-4 col-xs-12');
        } else {
            $('#content .product-layout').attr('class', 'product-layout product-grid col-lg-3 col-md-3 col-sm-6 col-xs-12');
        }

        localStorage.setItem('display', 'grid');
    });

    if (localStorage.getItem('display') == 'list') {
        $('#list-view').trigger('click');
    } else {
        $('#grid-view').trigger('click');
    }

    // tooltips on hover
    $('[data-toggle=\'tooltip\']').tooltip({container: 'body'});

    // Makes tooltips work on ajax generated content
    $(document).ajaxStop(function() {
        $('[data-toggle=\'tooltip\']').tooltip({container: 'body'});
    });

    if ($('.alert').length > 0) {
        setTimeout(function() {$('.alert').fadeOut(1000)},3000)
    }
});


var o = $('#gallery_zoom');
if (o.length > 0) {
    $(document).ready(function () {
        o.bind("click", function (e) {
            var ez = o.data('elevateZoom');
            $.fancybox(ez.getGalleryList());
            return false;
        });

        o.elevateZoom({
            gallery: 'image-additional',
            cursor: 'pointer',
            zoomType: 'inner',
            galleryActiveClass: 'active',
            imageCrossfade: true
        });
    });
}

var o2 = $('#image-additional');
if (o2.length) {
    $(document).ready(function () {
        $('#image-additional').bxSlider({
            mode: 'vertical',
            pager: false,
            controls: true,
            slideMargin: 13,
            minSlides: 5,
            maxSlides: 5,
            slideWidth: 88,
            nextText: '<i class="fa fa-chevron-down"></i>',
            prevText: '<i class="fa fa-chevron-up"></i>',
            infiniteLoop: false,
            adaptiveHeight: true,
            moveSlides: 1
        });
    });
}

var o1 = $('#gallery');
if (o1.length) {
    $(document).ready(function () {
        $('#gallery').bxSlider({
            pager: false,
            controls: true,
            minSlides: 1,
            maxSlides: 1,
            infiniteLoop: false,
            moveSlides: 1
        });
    });
}

var o3 = $('.related-slider');
if (o3.length > 0) {
    $(document).ready(function () {
        o3.owlCarousel({
            items : 4,
            itemsCustom : false,
            itemsDesktop : [1199, 4],
            itemsDesktopSmall : [980, 3],
            itemsTablet: [768, 2],
            itemsTabletSmall: false,
            itemsMobile : [479, 1],
            pagination: false,
            navigation : true,
            navigationText: [
                '<i class="fa fa-chevron-left"></i>',
                '<i class="fa fa-chevron-right"></i>'
            ],
        });
    });
}

var o4 = $('.box-carousel');
if (o4.length > 0) {
    $(document).ready(function () {
        o4.owlCarousel({
            items : 4,
            itemsCustom : false,
            itemsDesktop : [1199, 3],
            itemsDesktopSmall : [980, 2],
            itemsTablet: [768, 2],
            itemsTabletSmall: false,
            itemsMobile : [479, 1],
            pagination: false,
            navigation : false,
            navigationText: [
                '<i class="fa fa-chevron-left"></i>',
                '<i class="fa fa-chevron-right"></i>'
            ],
        });
        $(".box.latest .next").click(function(){
            o4.trigger('owl.next');
        })
        $(".box.latest .prev").click(function(){
            o4.trigger('owl.prev');
        })
    });
}

var o5 = $('.quickview');
if (o5.length) {
    $(document).ready(function () {
        o5.fancybox({
            maxWidth: 800,
            maxHeight: 600,
            fitToView: false,
            width: '70%',
            height: '70%',
            autoSize: false,
            closeClick: false,
            openEffect: 'elastic',
            closeEffect: 'elastic'
        });
    });
}

if ($('.c-rating').length > 0) {
    var c_rating = document.querySelector('.c-rating');
    var currentRating = 0;
    var maxRating= 5;
    var my_rating = rating(c_rating, currentRating, maxRating);
}

$(document).delegate('.agree', 'click', function(e) {
    e.preventDefault();
    $('#modal-agree').remove();
    var element = this;

    $.ajax({
        url: $(element).attr('href'),
        type: 'get',
        dataType: 'html',
        success: function(data) {
            html  = '<div id="modal-agree" class="modal">';
            html += '  <div class="modal-dialog">';
            html += '    <div class="modal-content">';
            html += '      <div class="modal-header">';
            html += '        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>';
            html += '        <h4 class="modal-title">' + $(element).text() + '</h4>';
            html += '      </div>';
            html += '      <div class="modal-body">' + data + '</div>';
            html += '    </div';
            html += '  </div>';
            html += '</div>';
            $('body').append(html);
            $('#modal-agree').modal('show');
        }
    });
});

function updateItem(product_id)
{
    var qt = $('#cart-q-' + product_id).val();
    $.ajax({
        url: Routing.generate('_cart_update'),
        type: 'post',
        data: {'product_id': product_id, 'quantity': qt},
        dataType: 'json',
        beforeSend: function() {
            $('#cart-m-' + product_id).button('loading');
        },
        success: function(data) {
            $('#cart-m-' + product_id).button('reset');
            if (data['delete'] == false) {
                if (data['success'] == true) {
                    $("#total_sub_price").text(data['total_g'] + ' DT');
                    $("#total_price").text(data['total_g'] + ' DT');
                    $("#total_price_" + product_id).text(data['total_p'] + ' DT');
                    $("#p-s-" + product_id).text(data['rest'] + ' article(s) restant');
                }
            } else {
                $(location).attr('href', Routing.generate('_cart'));
            }
        }
    });
}

function removeItem(product_id)
{
    $.ajax({
        url: Routing.generate('_cart_remove'),
        type: 'post',
        data: {'product_id': product_id},
        dataType: 'json',
        beforeSend: function() {
            $('#cart-d-' + product_id).button('loading');
        },
        success: function(data) {
            $('#cart-d-' + product_id).button('reset');
            $(location).attr('href', Routing.generate('_cart'));
        }
    });
}

function removeCartItem(product_id)
{
    $.ajax({
        url: Routing.generate('_cart_remove'),
        type: 'post',
        data: {'product_id': product_id},
        dataType: 'json',
        success: function(data) {
            $(location).attr('href', Routing.generate('_cart'));
        }
    });
}

function addItem(product_id)
{
    var qt = jQuery('#p-quantity').val();
    jQuery.ajax({
        url: Routing.generate('_cart_add'),
        type: 'post',
        data: {'product_id': product_id, 'quantity': qt},
        dataType: 'json',
        beforeSend: function() {
            jQuery('#button-cart').button('loading');
        },
        complete: function() {
            jQuery('#button-cart').button('reset');
        },
        success: function(data) {
            jQuery(location).attr('href', Routing.generate('_product_detail', {slug: jQuery('#product_slug').val()}));
        }
    });
}
